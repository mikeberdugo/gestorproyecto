{% extends 'plantilla.html' %}
{% load static %}

{% block title %} Gestión de Proyecto - {{ proyecto.name }} {% endblock %}
{% block name %}
    {{ proyecto.name }}
{% endblock %}

{% block css %}
    <link rel="stylesheet" href="{% static './css/stilos_kanban.css' %}">
{% endblock %}

{% block conten %}
   <tg-legacy ng-version="10.0.14"></tg-legacy>
    <div tg-navigation-bar="" ng-if="!errorHandling.showingError">

    </div>
    <div ng-if="!errorHandling.showingError">
        <div ng-view="" class="master">
            <tg-create-project-form type="kanban">
                <div class="create-project">
                    <div class="tarjeta">
                        <div class="titulo">
                        <h1  class="create-project-title">Nueva actividad</h1>
                    </div>

        <form name="actividadForm" class="ng-pristine ng-invalid ng-invalid-required" method="POST">
            {% csrf_token %}

            <fieldset>
                <label for="actividad-fase">Fase</label>
                <select name="actividad-fase" id="fasedes" onchange="actualizarSubfasesYTareas()">
                    <option value="" disabled selected>Selecciona una opción</option>
                    {% for fase, subfases_y_tareas in data.items %}
                        <option value="{{ fase }}">{{ fase }}</option>
                    {% endfor %}
                </select>
            </fieldset>


            <fieldset>
                <label for="subfasedes">Sub-Fase</label>
                <select id="subfasedes" name='subfase' onchange="actualizarTareas()" >

                </select>
            </fieldset>
            <div>
                <fieldset>
                    <label for="actividad-nombre">Tarea</label>
                    <select id="tarea" name="actividad-nombre">

                    </select>
                </fieldset>
            </div>

            <div>
                <fieldset>
                    <label for="actividad-descripcion">Descripción</label>
                    <textarea id="actividad-descripcion" placeholder="Descripción de la Actividad (Requerido)" name="actividad-descripcion" required="required" class="ng-pristine ng-untouched ng-empty ng-invalid ng-invalid-required" aria-invalid="true"></textarea>
                </fieldset>
            </div>



            <fieldset>
                <label for="actividad-fecha-inicio">Fecha de Inicio</label>
                <input type="date" id="actividad-fecha-inicio" name="actividad-fecha-inicio" required="required">
            </fieldset>
            <fieldset>
                <label for="actividad-fecha-fin">Fecha de Fin</label>
                <input type="date" id="actividad-fecha-fin" name="actividad-fecha-fin" required="required">
            </fieldset>

            <fieldset>
                <label for="horas-estimadas">Horas Estimadas</label>
                <input type="number" id="horas-estimadas" name="horas-estimadas" required>
            </fieldset>

            <div class="container">
                <fieldset>
                    <legend>Observaciones</legend>
                    <textarea id="observaciones" name="observaciones" rows="4" cols="50"></textarea>
                </fieldset>

                <fieldset>
                    <label for="porcentaje">Porcentaje:</label>
                    <input type="number" id="porcentaje" name="porcentaje" min="0" max="100" step="1" required>
                </fieldset>
            </div>
            <fieldset>
                <label for="dependencia">Dependencia</label>
                <select id="dependencia" name="dependencia">
                    <option value="" disabled selected>Selecciona una opción</option>
                    {% for de in des %}
                        <option value="{{ de.titulo }}"> {{de.titulo}} </option>
                    {% endfor %}
                </select>
            </fieldset>
            <fieldset>
                <label for="actividad-complejidad">Complejidad</label>
                <select id="actividad-complejidad" name="actividad-complejidad">
                    <option value="4">Critico</option>
                    <option value="3">Alto</option>
                    <option value="2">Medio</option>
                    <option value="1">Bajo</option>
                    <option value="5" disabled selected>Selecciona una opción</option>
                </select>
            </fieldset>

            <div>
                <div class="create-project-action">
                    <a href="{% url 'main:des' codigo=proyecto.codigo %} " variant="secondary" type="button" title="Volver" class="btn-small create-project-action-cancel" >Volver</a>
                    <button type="submit" class="btn-small create-project-action-submit" title="Asignar Proyecto">Crear Actividad</button>
                </div>
            </div>
        </form>

               </div>
            </tg-create-project-form>
        </div>
    </div>



{% endblock %}

{% block scripts %}
    <script src="{% static './js/scripts.js' %}"></script>



<script>
    var data = {{ data|safe }};

    function actualizarSubfasesYTareas() {
        var selectedFase = document.getElementById("fasedes").value;
        var subfases = data[selectedFase]["subfases"];

        var subfasedesDropdown = document.getElementById("subfasedes");
        var tareaDropdown = document.getElementById("tarea");

        // Limpiar las opciones anteriores
        subfasedesDropdown.innerHTML = "";
        tareaDropdown.innerHTML = "";

        // Llenar las opciones de subfases
        for (var i = 0; i < subfases.length; i++) {
            var option = document.createElement("option");
            option.text = subfases[i];
            subfasedesDropdown.add(option);
        }

        // Actualizar las tareas al cambiar la fase
        actualizarTareas();
    }

    function actualizarTareas() {
        var selectedFase = document.getElementById("fasedes").value;
        var selectedSubfase = document.getElementById("subfasedes").value;
        var tareas = data[selectedFase]["tareas"];

        var tareaDropdown = document.getElementById("tarea");

        // Limpiar las opciones anteriores
        tareaDropdown.innerHTML = "";

        // Llenar las opciones de tareas
        for (var j = 0; j < tareas.length; j++) {
            var option = document.createElement("option");
            option.text = tareas[j];
            tareaDropdown.add(option);
        }
    }


        const startDateInput = document.getElementById('project-start-date-planned');

        const endDateInput = document.getElementById('project-end-date-planned');

        startDateInput.addEventListener('change', function() {

          const selectedStartDate = new Date(this.value);

          const endDateMin = selectedStartDate.toISOString().split('T')[0];

          endDateInput.min = endDateMin;

        });

</script>


{% endblock %}
